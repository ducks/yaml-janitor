#!/usr/bin/env ruby
# frozen_string_literal: true

require_relative "../lib/yaml_janitor"

def print_usage
  puts <<~USAGE
    Usage: yaml-janitor [options] <file_or_directory>

    Options:
      --fix               Auto-fix issues where possible
      --rules RULES       Comma-separated list of rules (default: all)
      --config PATH       Path to config file (default: .yaml-janitor.yml)
      --indentation N     Number of spaces for indentation (default: 2)
      --line-width N      Maximum line width (default: 80)
      --help              Show this help message

    Examples:
      yaml-janitor config.yml
      yaml-janitor --fix config.yml
      yaml-janitor --rules multiline_certificate containers/
      yaml-janitor --config my-config.yml --fix config.yml
      yaml-janitor --indentation 4 --line-width 100 config.yml
  USAGE
  exit 0
end

# Parse args
fix = false
rules = :all
config_path = nil
config_overrides = {}
paths = []

i = 0
while i < ARGV.length
  case ARGV[i]
  when "--fix"
    fix = true
  when "--rules"
    i += 1
    rules = ARGV[i].split(",").map(&:to_sym)
  when "--config"
    i += 1
    config_path = ARGV[i]
  when "--indentation"
    i += 1
    config_overrides[:indentation] = ARGV[i].to_i
  when "--line-width"
    i += 1
    config_overrides[:line_width] = ARGV[i].to_i
  when "--help", "-h"
    print_usage
  else
    paths << ARGV[i]
  end
  i += 1
end

if paths.empty?
  puts "Error: No files or directories specified"
  print_usage
end

# Look for default config if not specified
if !config_path && File.exist?(".yaml-janitor.yml")
  config_path = ".yaml-janitor.yml"
end

# Process files
config = YamlJanitor::Config.new(config_path: config_path, overrides: config_overrides)
linter = YamlJanitor::Linter.new(rules: rules, config: config)
total_files = 0
total_violations = 0
files_with_violations = []

paths.each do |path|
  if File.directory?(path)
    # Process all YAML files in directory
    yaml_files = Dir.glob(File.join(path, "**", "*.{yml,yaml}"))
    yaml_files.each do |file|
      total_files += 1
      result = linter.lint_file(file, fix: fix)

      if result[:violations].any?
        files_with_violations << file
        total_violations += result[:violations].length

        puts "\n#{file}:"
        result[:violations].each do |violation|
          puts "  #{violation}"
        end

        if fix && result[:fixed]
          puts "  ✓ Fixed"
        end
      end
    end
  elsif File.file?(path)
    # Process single file
    total_files += 1
    result = linter.lint_file(path, fix: fix)

    if result[:violations].any?
      files_with_violations << path
      total_violations += result[:violations].length

      puts "\n#{path}:"
      result[:violations].each do |violation|
        puts "  #{violation}"
      end

      if fix && result[:fixed]
        puts "  ✓ Fixed"
      end
    end
  else
    puts "Warning: #{path} not found"
  end
end

# Summary
puts "\n" + "="*60
puts "Checked #{total_files} files"
puts "Found #{total_violations} violations in #{files_with_violations.length} files"

if total_violations > 0
  exit 1
else
  puts "✓ All files clean!"
  exit 0
end
