#!/usr/bin/env ruby
# frozen_string_literal: true

require_relative "../lib/yaml_janitor"

def print_usage
  puts <<~USAGE
    Usage: yaml-janitor [options] <file_or_directory>

    Options:
      --fix           Auto-fix issues where possible
      --rules RULES   Comma-separated list of rules (default: all)
      --help          Show this help message

    Examples:
      yaml-janitor config.yml
      yaml-janitor --fix config.yml
      yaml-janitor --rules multiline_certificate containers/
  USAGE
  exit 0
end

# Parse args
fix = false
rules = :all
paths = []

i = 0
while i < ARGV.length
  case ARGV[i]
  when "--fix"
    fix = true
  when "--rules"
    i += 1
    rules = ARGV[i].split(",").map(&:to_sym)
  when "--help", "-h"
    print_usage
  else
    paths << ARGV[i]
  end
  i += 1
end

if paths.empty?
  puts "Error: No files or directories specified"
  print_usage
end

# Process files
linter = YamlJanitor::Linter.new(rules: rules)
total_files = 0
total_violations = 0
files_with_violations = []

paths.each do |path|
  if File.directory?(path)
    # Process all YAML files in directory
    yaml_files = Dir.glob(File.join(path, "**", "*.{yml,yaml}"))
    yaml_files.each do |file|
      total_files += 1
      result = linter.lint_file(file, fix: fix)

      if result[:violations].any?
        files_with_violations << file
        total_violations += result[:violations].length

        puts "\n#{file}:"
        result[:violations].each do |violation|
          puts "  #{violation}"
        end

        if fix && result[:fixed]
          puts "  ✓ Fixed"
        end
      end
    end
  elsif File.file?(path)
    # Process single file
    total_files += 1
    result = linter.lint_file(path, fix: fix)

    if result[:violations].any?
      files_with_violations << path
      total_violations += result[:violations].length

      puts "\n#{path}:"
      result[:violations].each do |violation|
        puts "  #{violation}"
      end

      if fix && result[:fixed]
        puts "  ✓ Fixed"
      end
    end
  else
    puts "Warning: #{path} not found"
  end
end

# Summary
puts "\n" + "="*60
puts "Checked #{total_files} files"
puts "Found #{total_violations} violations in #{files_with_violations.length} files"

if total_violations > 0
  exit 1
else
  puts "✓ All files clean!"
  exit 0
end
